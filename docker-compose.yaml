version: "3.9"

services:
  # Reverse proxy
  proxy:
    image: jwilder/nginx-proxy
    container_name: proxy
    networks:
      - webnet
    ports:
      - "0.0.0.0:80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./nginx/vhost.d:/etc/nginx/vhost.d:ro
      - ./nginx/html:/usr/share/nginx/html
    restart: unless-stopped

  # Log output service
  log-output:
    build: ./log_output
    container_name: log-output
    environment:
      NODE_ENV: development
      PORT: 3000
      VIRTUAL_PORT: 3000
      VIRTUAL_HOST: log-output.colasloth.com
      LOG_LEVEL: info
      SERVICE_NAME: log-output
    ports:
      - "3001:3000"
    networks:
      - webnet
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]

  # Backend service
  todo-app:
    build: ./the_project/todo-app
    container_name: todo-app
    environment:
      NODE_ENV: development
      TODO_PORT: 3000
      VIRTUAL_PORT: 3000
      VIRTUAL_HOST: todo-app.colasloth.com
      VIRTUAL_PATH: /api/
      # Fetch log-output via Docker internal network, not domain
      API_URL: http://log-output:3000
      SERVICE_NAME: todo-app
    ports:
      - "3002:3000"
    networks:
      - webnet
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]

  # Frontend service
  todo-frontend:
    build:
      context: ./the_project/todo-frontend
      args:
        # Use Docker service name, not external domain
        VITE_API_URL: todo-app:3002
        VITE_API_VERSION: v1.4
        VITE_ENV: production
        VITE_APP_VERSION: 1.4.0
    environment:
      NODE_ENV: development
      VIRTUAL_PORT: 80
      VIRTUAL_HOST: todo-page.colasloth.com
      SERVICE_NAME: todo-page
    ports:
      - "4000:80"
    networks:
      - webnet
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  webnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
