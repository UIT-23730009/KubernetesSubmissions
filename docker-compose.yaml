version: "3.9"

services:
  proxy:
    image: jwilder/nginx-proxy
    networks:
      - webnet
    ports:
      - "0.0.0.0:80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro

  log-output:
    build: ./log_output
    environment:
      - NODE_ENV=development
      - PORT=3000
      - VIRTUAL_PORT=3000
      - VIRTUAL_HOST=log-output.colasloth.com
      - LOG_LEVEL=info
      - SERVICE_NAME=log-output
    ports:
      - "3001:3000"
    networks:
      - webnet
    command: sh -c "npm install && npm run start -- --port 3000"
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/health || exit 1"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s

  todo-app:
    build: ./the_project/todo-app
    environment:
      - NODE_ENV=development
      - TODO_PORT=3000
      - VIRTUAL_PORT=3000
      - VIRTUAL_HOST=todo-app.colasloth.com
      - API_URL=http://log-output:3001
      - SERVICE_NAME=todo-app
    ports:
      - "3002:3000"
    networks:
      - webnet
    command: sh -c "npm install && npm run start -- --port 3000"
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3002/health || exit 1"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  webnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
      driver: default
